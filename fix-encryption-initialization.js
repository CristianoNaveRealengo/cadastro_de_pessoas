/**
 * Script para Diagnosticar e Corrigir Problemas de Inicializa√ß√£o da Criptografia
 * 
 * Problema identificado: "Chave de criptografia n√£o inicializada"
 * Causa: Sistema de criptografia sendo usado antes da inicializa√ß√£o da chave
 * 
 * @author Sistema de Corre√ß√£o
 * @version 1.0.0
 */

class EncryptionInitializationFixer {
    constructor() {
        this.diagnosticResults = [];
        this.fixResults = [];
        this.isInitialized = false;
    }

    /**
     * Executa diagn√≥stico completo do sistema de criptografia
     */
    async runDiagnostic() {
        console.log('üîç Iniciando diagn√≥stico do sistema de criptografia...');
        this.diagnosticResults = [];

        // 1. Verificar se o sistema de criptografia est√° carregado
        this.checkEncryptionSystemLoaded();

        // 2. Verificar se o Firebase Auth est√° dispon√≠vel
        this.checkFirebaseAuth();

        // 3. Verificar se h√° usu√°rio logado
        this.checkCurrentUser();

        // 4. Verificar se a chave est√° inicializada
        this.checkEncryptionKey();

        // 5. Verificar ordem de carregamento dos scripts
        this.checkScriptLoadOrder();

        // 6. Verificar se h√° dados pendentes de criptografia
        this.checkPendingData();

        return this.diagnosticResults;
    }

    /**
     * Verifica se o sistema de criptografia est√° carregado
     */
    checkEncryptionSystemLoaded() {
        const result = {
            test: 'Sistema de Criptografia Carregado',
            status: 'unknown',
            details: [],
            solution: null
        };

        if (window.dataEncryption) {
            result.status = 'success';
            result.details.push('‚úÖ window.dataEncryption est√° dispon√≠vel');
            result.details.push(`‚úÖ Algoritmo: ${window.dataEncryption.algorithm}`);
            result.details.push(`‚úÖ Campos sens√≠veis: ${window.dataEncryption.sensitiveFields.length}`);
        } else {
            result.status = 'error';
            result.details.push('‚ùå window.dataEncryption n√£o est√° dispon√≠vel');
            result.solution = 'Verificar se o script data-encryption.js est√° carregado';
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Verifica se o Firebase Auth est√° dispon√≠vel
     */
    checkFirebaseAuth() {
        const result = {
            test: 'Firebase Auth Dispon√≠vel',
            status: 'unknown',
            details: [],
            solution: null
        };

        if (window.auth) {
            result.status = 'success';
            result.details.push('‚úÖ window.auth est√° dispon√≠vel');
            result.details.push(`‚úÖ App: ${window.auth.app?.name || 'N/A'}`);
        } else {
            result.status = 'error';
            result.details.push('‚ùå window.auth n√£o est√° dispon√≠vel');
            result.solution = 'Verificar se o Firebase Auth foi inicializado';
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Verifica se h√° usu√°rio logado
     */
    checkCurrentUser() {
        const result = {
            test: 'Usu√°rio Autenticado',
            status: 'unknown',
            details: [],
            solution: null
        };

        if (window.auth && window.auth.currentUser) {
            result.status = 'success';
            result.details.push('‚úÖ Usu√°rio est√° logado');
            result.details.push(`‚úÖ Email: ${window.auth.currentUser.email}`);
            result.details.push(`‚úÖ UID: ${window.auth.currentUser.uid.substring(0, 8)}...`);
        } else {
            result.status = 'warning';
            result.details.push('‚ö†Ô∏è Nenhum usu√°rio logado');
            result.solution = 'Fazer login antes de usar criptografia';
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Verifica se a chave de criptografia est√° inicializada
     */
    checkEncryptionKey() {
        const result = {
            test: 'Chave de Criptografia',
            status: 'unknown',
            details: [],
            solution: null
        };

        if (window.dataEncryption) {
            if (window.dataEncryption.encryptionKey) {
                result.status = 'success';
                result.details.push('‚úÖ Chave de criptografia inicializada');
                this.isInitialized = true;
            } else {
                result.status = 'error';
                result.details.push('‚ùå Chave de criptografia N√ÉO inicializada');
                result.solution = 'Inicializar chave com email do usu√°rio';
            }
        } else {
            result.status = 'error';
            result.details.push('‚ùå Sistema de criptografia n√£o dispon√≠vel');
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Verifica ordem de carregamento dos scripts
     */
    checkScriptLoadOrder() {
        const result = {
            test: 'Ordem de Carregamento dos Scripts',
            status: 'unknown',
            details: [],
            solution: null
        };

        const requiredOrder = [
            'data-encryption.js',
            'encryption-integration.js'
        ];

        const scripts = Array.from(document.querySelectorAll('script[src]'))
            .map(script => script.src.split('/').pop())
            .filter(src => requiredOrder.includes(src));

        if (scripts.length === requiredOrder.length) {
            result.status = 'success';
            result.details.push('‚úÖ Scripts de criptografia carregados');
            result.details.push(`‚úÖ Ordem: ${scripts.join(' ‚Üí ')}`);
        } else {
            result.status = 'warning';
            result.details.push('‚ö†Ô∏è Alguns scripts podem n√£o estar carregados');
            result.details.push(`üìã Encontrados: ${scripts.join(', ')}`);
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Verifica se h√° dados pendentes de criptografia
     */
    checkPendingData() {
        const result = {
            test: 'Dados Pendentes',
            status: 'unknown',
            details: [],
            solution: null
        };

        if (window.appData && window.appData.records) {
            const totalRecords = window.appData.records.length;
            const encryptedRecords = window.appData.records.filter(r => r._encrypted).length;
            const unencryptedRecords = totalRecords - encryptedRecords;

            result.details.push(`üìä Total de registros: ${totalRecords}`);
            result.details.push(`üîê Registros criptografados: ${encryptedRecords}`);
            result.details.push(`üìù Registros n√£o criptografados: ${unencryptedRecords}`);

            if (unencryptedRecords > 0) {
                result.status = 'warning';
                result.solution = 'Migrar dados n√£o criptografados';
            } else {
                result.status = 'success';
            }
        } else {
            result.status = 'info';
            result.details.push('‚ÑπÔ∏è Nenhum dado encontrado');
        }

        this.diagnosticResults.push(result);
    }

    /**
     * Aplica corre√ß√µes autom√°ticas
     */
    async applyFixes() {
        console.log('üîß Aplicando corre√ß√µes autom√°ticas...');
        this.fixResults = [];

        // 1. Inicializar chave se usu√°rio estiver logado
        await this.fixEncryptionKey();

        // 2. Configurar listeners adequados
        await this.fixAuthListeners();

        // 3. Migrar dados se necess√°rio
        await this.fixDataMigration();

        return this.fixResults;
    }

    /**
     * Corrige inicializa√ß√£o da chave de criptografia
     */
    async fixEncryptionKey() {
        const result = {
            fix: 'Inicializa√ß√£o da Chave de Criptografia',
            status: 'unknown',
            details: [],
            error: null
        };

        try {
            if (!window.dataEncryption) {
                result.status = 'error';
                result.details.push('‚ùå Sistema de criptografia n√£o dispon√≠vel');
                this.fixResults.push(result);
                return;
            }

            if (!window.auth || !window.auth.currentUser) {
                result.status = 'warning';
                result.details.push('‚ö†Ô∏è Usu√°rio n√£o est√° logado');
                result.details.push('üí° Aguardando login para inicializar chave');
                this.fixResults.push(result);
                return;
            }

            const userEmail = window.auth.currentUser.email;
            
            // Inicializar chave
            await window.dataEncryption.initializeKey(userEmail);
            
            // Testar criptografia
            const testResult = await window.dataEncryption.testEncryption();
            
            if (testResult) {
                result.status = 'success';
                result.details.push('‚úÖ Chave de criptografia inicializada');
                result.details.push(`‚úÖ Usu√°rio: ${userEmail}`);
                result.details.push('‚úÖ Teste de criptografia passou');
                this.isInitialized = true;
            } else {
                result.status = 'error';
                result.details.push('‚ùå Falha no teste de criptografia');
            }

        } catch (error) {
            result.status = 'error';
            result.error = error.message;
            result.details.push(`‚ùå Erro: ${error.message}`);
        }

        this.fixResults.push(result);
    }

    /**
     * Configura listeners de autentica√ß√£o adequados
     */
    async fixAuthListeners() {
        const result = {
            fix: 'Configura√ß√£o de Listeners de Auth',
            status: 'unknown',
            details: [],
            error: null
        };

        try {
            if (!window.auth) {
                result.status = 'error';
                result.details.push('‚ùå Firebase Auth n√£o dispon√≠vel');
                this.fixResults.push(result);
                return;
            }

            // Configurar listener para mudan√ßas de autentica√ß√£o
            window.auth.onAuthStateChanged(async (user) => {
                if (user && window.dataEncryption && !window.dataEncryption.encryptionKey) {
                    try {
                        console.log('üîê Inicializando criptografia para usu√°rio logado:', user.email);
                        await window.dataEncryption.initializeKey(user.email);
                        
                        const testResult = await window.dataEncryption.testEncryption();
                        if (testResult) {
                            console.log('‚úÖ Criptografia inicializada automaticamente');
                            this.showEncryptionStatus(true);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro na inicializa√ß√£o autom√°tica:', error);
                        this.showEncryptionStatus(false);
                    }
                }
            });

            result.status = 'success';
            result.details.push('‚úÖ Listener de autentica√ß√£o configurado');
            result.details.push('‚úÖ Inicializa√ß√£o autom√°tica ativada');

        } catch (error) {
            result.status = 'error';
            result.error = error.message;
            result.details.push(`‚ùå Erro: ${error.message}`);
        }

        this.fixResults.push(result);
    }

    /**
     * Migra dados n√£o criptografados
     */
    async fixDataMigration() {
        const result = {
            fix: 'Migra√ß√£o de Dados',
            status: 'unknown',
            details: [],
            error: null
        };

        try {
            if (!this.isInitialized) {
                result.status = 'warning';
                result.details.push('‚ö†Ô∏è Chave n√£o inicializada, pulando migra√ß√£o');
                this.fixResults.push(result);
                return;
            }

            if (!window.appData || !window.appData.records) {
                result.status = 'info';
                result.details.push('‚ÑπÔ∏è Nenhum dado para migrar');
                this.fixResults.push(result);
                return;
            }

            const unencryptedRecords = window.appData.records.filter(r => !r._encrypted);
            
            if (unencryptedRecords.length === 0) {
                result.status = 'success';
                result.details.push('‚úÖ Todos os dados j√° est√£o criptografados');
                this.fixResults.push(result);
                return;
            }

            // Fazer backup
            const backupKey = `personalRecords_backup_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify(window.appData.records));
            
            result.details.push(`üíæ Backup criado: ${backupKey}`);
            result.details.push(`üìä Migrando ${unencryptedRecords.length} registros`);

            // Migrar dados
            for (let i = 0; i < unencryptedRecords.length; i++) {
                const record = unencryptedRecords[i];
                await window.dataEncryption.encryptRecord(record);
                result.details.push(`‚úÖ Registro ${i + 1}/${unencryptedRecords.length} migrado`);
            }

            // Salvar dados migrados
            if (window.saveData) {
                await window.saveData();
                result.details.push('üíæ Dados migrados salvos');
            }

            result.status = 'success';
            result.details.push('‚úÖ Migra√ß√£o conclu√≠da com sucesso');

        } catch (error) {
            result.status = 'error';
            result.error = error.message;
            result.details.push(`‚ùå Erro na migra√ß√£o: ${error.message}`);
        }

        this.fixResults.push(result);
    }

    /**
     * Mostra status da criptografia na interface
     */
    showEncryptionStatus(isActive) {
        // Criar ou atualizar indicador visual
        let indicator = document.getElementById('encryptionStatus');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'encryptionStatus';
            indicator.className = 'fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium';
            document.body.appendChild(indicator);
        }

        if (isActive) {
            indicator.className = 'fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium bg-green-100 text-green-800 border border-green-200';
            indicator.innerHTML = '<i class="fas fa-shield-alt mr-2"></i>Criptografia Ativa';
        } else {
            indicator.className = 'fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium bg-red-100 text-red-800 border border-red-200';
            indicator.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Criptografia Inativa';
        }

        // Remover ap√≥s 5 segundos
        setTimeout(() => {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }, 5000);
    }

    /**
     * For√ßa inicializa√ß√£o da criptografia
     */
    async forceInitialization() {
        console.log('üöÄ For√ßando inicializa√ß√£o da criptografia...');
        
        try {
            if (!window.auth || !window.auth.currentUser) {
                throw new Error('Usu√°rio n√£o est√° logado');
            }

            if (!window.dataEncryption) {
                throw new Error('Sistema de criptografia n√£o dispon√≠vel');
            }

            const userEmail = window.auth.currentUser.email;
            
            // For√ßar inicializa√ß√£o
            await window.dataEncryption.initializeKey(userEmail);
            
            // Testar
            const testResult = await window.dataEncryption.testEncryption();
            
            if (testResult) {
                console.log('‚úÖ Inicializa√ß√£o for√ßada bem-sucedida');
                this.showEncryptionStatus(true);
                return { success: true, message: 'Criptografia inicializada com sucesso' };
            } else {
                throw new Error('Falha no teste de criptografia');
            }

        } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o for√ßada:', error);
            this.showEncryptionStatus(false);
            return { success: false, message: error.message };
        }
    }

    /**
     * Gera relat√≥rio completo
     */
    generateReport() {
        const report = {
            timestamp: new Date().toISOString(),
            diagnostic: this.diagnosticResults,
            fixes: this.fixResults,
            summary: {
                totalTests: this.diagnosticResults.length,
                passedTests: this.diagnosticResults.filter(r => r.status === 'success').length,
                failedTests: this.diagnosticResults.filter(r => r.status === 'error').length,
                warningTests: this.diagnosticResults.filter(r => r.status === 'warning').length,
                totalFixes: this.fixResults.length,
                successfulFixes: this.fixResults.filter(r => r.status === 'success').length,
                failedFixes: this.fixResults.filter(r => r.status === 'error').length
            }
        };

        return report;
    }
}

// Disponibilizar globalmente
window.EncryptionInitializationFixer = EncryptionInitializationFixer;

console.log('üîß Sistema de corre√ß√£o de criptografia carregado');