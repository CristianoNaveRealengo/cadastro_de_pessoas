// ==============================================
// SISTEMA DE DETEC√á√ÉO AUTOM√ÅTICA DE AMBIENTE
// ==============================================

/**
 * Sistema avan√ßado de detec√ß√£o de ambiente para aplica√ß√µes web
 * - Detecta automaticamente produ√ß√£o, desenvolvimento, teste e staging
 * - Identifica contextos espec√≠ficos (PWA, Electron, Mobile, etc.)
 * - Fornece informa√ß√µes detalhadas sobre o ambiente de execu√ß√£o
 * - Suporte a configura√ß√µes personalizadas por ambiente
 */

class EnvironmentDetector {
	constructor() {
		this.environmentInfo = this.detectEnvironment();
		this.initializeEnvironmentSpecificFeatures();
	}

	/**
	 * Detecta o ambiente atual baseado em m√∫ltiplos fatores
	 * @returns {Object} Informa√ß√µes completas do ambiente
	 */
	detectEnvironment() {
		const location = window.location;
		const userAgent = navigator.userAgent;
		const hostname = location.hostname;
		const protocol = location.protocol;
		const port = location.port;

		// Detec√ß√£o b√°sica de ambiente
		const isLocalhost = this.isLocalhostEnvironment(hostname);
		const isHttps = protocol === 'https:';
		const isDevelopmentPort = this.isDevelopmentPort(port);
		const isFileProtocol = protocol === 'file:';

		// Detec√ß√£o de ambiente espec√≠fico
		const environmentType = this.determineEnvironmentType({
			isLocalhost,
			isHttps,
			isDevelopmentPort,
			isFileProtocol,
			hostname
		});

		// Detec√ß√£o de contexto de execu√ß√£o
		const executionContext = this.detectExecutionContext(userAgent);

		// Detec√ß√£o de recursos dispon√≠veis
		const availableFeatures = this.detectAvailableFeatures();

		return {
			// Informa√ß√µes b√°sicas
			type: environmentType,
			isProduction: environmentType === 'production',
			isDevelopment: environmentType === 'development',
			isStaging: environmentType === 'staging',
			isTest: environmentType === 'test',

			// Detalhes t√©cnicos
			protocol,
			hostname,
			port,
			isSecure: isHttps,
			isLocalhost,

			// Contexto de execu√ß√£o
			executionContext,

			// Recursos dispon√≠veis
			availableFeatures,

			// Timestamp da detec√ß√£o
			detectedAt: new Date().toISOString(),

			// Configura√ß√µes recomendadas
			recommendedConfig: this.getRecommendedConfig(environmentType)
		};
	}

	/**
	 * Verifica se est√° executando em localhost
	 * @param {string} hostname - Nome do host
	 * @returns {boolean} True se for localhost
	 */
	isLocalhostEnvironment(hostname) {
		const localhostPatterns = [
			'localhost',
			'127.0.0.1',
			'0.0.0.0',
			'::1',
			'[::1]'
		];

		return localhostPatterns.some(pattern => 
			hostname.includes(pattern)
		) || hostname.endsWith('.local');
	}

	/**
	 * Verifica se a porta indica ambiente de desenvolvimento
	 * @param {string} port - N√∫mero da porta
	 * @returns {boolean} True se for porta de desenvolvimento
	 */
	isDevelopmentPort(port) {
		const developmentPorts = [
			'3000', '3001', '3002', // React, Next.js
			'4200', '4201', // Angular
			'5000', '5001', '5173', // Vite, Flask
			'8000', '8001', '8080', '8081', // Desenvolvimento geral
			'9000', '9001' // Webpack dev server
		];

		return developmentPorts.includes(port);
	}

	/**
	 * Determina o tipo de ambiente baseado nos indicadores
	 * @param {Object} indicators - Indicadores do ambiente
	 * @returns {string} Tipo do ambiente
	 */
	determineEnvironmentType({ isLocalhost, isHttps, isDevelopmentPort, isFileProtocol, hostname }) {
		// Ambiente de arquivo local
		if (isFileProtocol) {
			return 'local-file';
		}

		// Ambiente de desenvolvimento
		if (isLocalhost || isDevelopmentPort) {
			return 'development';
		}

		// Ambiente de teste
		if (hostname.includes('test') || hostname.includes('qa')) {
			return 'test';
		}

		// Ambiente de staging
		if (hostname.includes('staging') || hostname.includes('stage') || hostname.includes('dev')) {
			return 'staging';
		}

		// Ambiente de produ√ß√£o (HTTPS obrigat√≥rio)
		if (isHttps) {
			return 'production';
		}

		// Ambiente inseguro (HTTP em produ√ß√£o)
		return 'insecure-production';
	}

	/**
	 * Detecta o contexto de execu√ß√£o da aplica√ß√£o
	 * @param {string} userAgent - User agent do navegador
	 * @returns {Object} Informa√ß√µes do contexto de execu√ß√£o
	 */
	detectExecutionContext(userAgent) {
		return {
			// Tipo de aplica√ß√£o
			isPWA: this.isPWAContext(),
			isElectron: userAgent.includes('Electron'),
			isWebView: userAgent.includes('wv') || userAgent.includes('WebView'),

			// Plataforma
			isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent),
			isTablet: /iPad|Android(?!.*Mobile)/i.test(userAgent),
			isDesktop: !/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent),

			// Navegador
			browser: this.detectBrowser(userAgent),

			// Sistema operacional
			os: this.detectOperatingSystem(userAgent)
		};
	}

	/**
	 * Verifica se est√° executando como PWA
	 * @returns {boolean} True se for PWA
	 */
	isPWAContext() {
		return (
			window.matchMedia('(display-mode: standalone)').matches ||
			window.navigator.standalone === true ||
			document.referrer.includes('android-app://')
		);
	}

	/**
	 * Detecta o navegador utilizado
	 * @param {string} userAgent - User agent
	 * @returns {string} Nome do navegador
	 */
	detectBrowser(userAgent) {
		if (userAgent.includes('Chrome')) return 'Chrome';
		if (userAgent.includes('Firefox')) return 'Firefox';
		if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
		if (userAgent.includes('Edge')) return 'Edge';
		if (userAgent.includes('Opera')) return 'Opera';
		return 'Unknown';
	}

	/**
	 * Detecta o sistema operacional
	 * @param {string} userAgent - User agent
	 * @returns {string} Nome do sistema operacional
	 */
	detectOperatingSystem(userAgent) {
		if (userAgent.includes('Windows')) return 'Windows';
		if (userAgent.includes('Mac')) return 'macOS';
		if (userAgent.includes('Linux')) return 'Linux';
		if (userAgent.includes('Android')) return 'Android';
		if (userAgent.includes('iOS') || userAgent.includes('iPhone') || userAgent.includes('iPad')) return 'iOS';
		return 'Unknown';
	}

	/**
	 * Detecta recursos dispon√≠veis no ambiente
	 * @returns {Object} Recursos dispon√≠veis
	 */
	detectAvailableFeatures() {
		return {
			// APIs do navegador
			serviceWorker: 'serviceWorker' in navigator,
			pushNotifications: 'PushManager' in window,
			geolocation: 'geolocation' in navigator,
			camera: 'mediaDevices' in navigator,
			offlineStorage: 'localStorage' in window,
			indexedDB: 'indexedDB' in window,

			// Recursos de seguran√ßa
			crypto: 'crypto' in window && 'subtle' in window.crypto,
			secureContext: window.isSecureContext,

			// Recursos de rede
			onlineStatus: 'onLine' in navigator,
			connection: 'connection' in navigator,

			// Recursos de performance
			performanceAPI: 'performance' in window,
			webWorkers: 'Worker' in window
		};
	}

	/**
	 * Obt√©m configura√ß√µes recomendadas para o ambiente
	 * @param {string} environmentType - Tipo do ambiente
	 * @returns {Object} Configura√ß√µes recomendadas
	 */
	getRecommendedConfig(environmentType) {
		const configs = {
			production: {
				debugMode: false,
				logging: 'error',
				caching: true,
				minification: true,
				securityLevel: 'high',
				analytics: true
			},
			staging: {
				debugMode: true,
				logging: 'warn',
				caching: true,
				minification: true,
				securityLevel: 'medium',
				analytics: false
			},
			development: {
				debugMode: true,
				logging: 'debug',
				caching: false,
				minification: false,
				securityLevel: 'low',
				analytics: false
			},
			test: {
				debugMode: true,
				logging: 'info',
				caching: false,
				minification: false,
				securityLevel: 'medium',
				analytics: false
			}
		};

		return configs[environmentType] || configs.development;
	}

	/**
	 * Inicializa recursos espec√≠ficos do ambiente
	 */
	initializeEnvironmentSpecificFeatures() {
		const { type, recommendedConfig } = this.environmentInfo;

		// Configurar logging baseado no ambiente
		this.configureLogging(recommendedConfig.logging);

		// Configurar debug mode
		if (recommendedConfig.debugMode) {
			this.enableDebugMode();
		}

		// Avisos de seguran√ßa
		if (type === 'insecure-production') {
			console.error('üö® AVISO DE SEGURAN√áA: Aplica√ß√£o em produ√ß√£o sem HTTPS!');
		}

		// Log de inicializa√ß√£o
		this.logEnvironmentInfo();
	}

	/**
	 * Configura o sistema de logging
	 * @param {string} level - N√≠vel de logging
	 */
	configureLogging(level) {
		const levels = {
			error: ['error'],
			warn: ['error', 'warn'],
			info: ['error', 'warn', 'info'],
			debug: ['error', 'warn', 'info', 'log', 'debug']
		};

		const allowedMethods = levels[level] || levels.error;

		// Desabilitar m√©todos de console n√£o permitidos
		['log', 'debug', 'info', 'warn', 'error'].forEach(method => {
			if (!allowedMethods.includes(method)) {
				console[method] = () => {};
			}
		});
	}

	/**
	 * Habilita modo de debug
	 */
	enableDebugMode() {
		// Disponibilizar informa√ß√µes globalmente
		window.environmentInfo = this.environmentInfo;
		window.environmentDetector = this;

		// Comandos √∫teis para debug
		window.envDebug = {
			info: () => this.getEnvironmentInfo(),
			reload: () => {
				this.environmentInfo = this.detectEnvironment();
				return this.environmentInfo;
			},
			features: () => this.environmentInfo.availableFeatures,
			context: () => this.environmentInfo.executionContext
		};
	}

	/**
	 * Registra informa√ß√µes do ambiente no console
	 */
	logEnvironmentInfo() {
		const { type, isProduction, executionContext } = this.environmentInfo;
		const emoji = this.getEnvironmentEmoji(type);

		console.log(`${emoji} Ambiente detectado: ${type.toUpperCase()}`);
		
		if (!isProduction) {
			console.log('üõ†Ô∏è Modo de desenvolvimento ativo');
			console.log('üí° Use envDebug.info() para ver detalhes completos');
		}

		if (executionContext.isPWA) {
			console.log('üì± Executando como PWA');
		}
	}

	/**
	 * Obt√©m emoji representativo do ambiente
	 * @param {string} type - Tipo do ambiente
	 * @returns {string} Emoji
	 */
	getEnvironmentEmoji(type) {
		const emojis = {
			production: 'üöÄ',
			staging: 'üé≠',
			development: 'üõ†Ô∏è',
			test: 'üß™',
			'local-file': 'üìÅ',
			'insecure-production': 'üö®'
		};

		return emojis[type] || '‚ùì';
	}

	/**
	 * Obt√©m informa√ß√µes completas do ambiente
	 * @returns {Object} Informa√ß√µes do ambiente
	 */
	getEnvironmentInfo() {
		return { ...this.environmentInfo };
	}

	/**
	 * Verifica se est√° em um ambiente espec√≠fico
	 * @param {string} environmentType - Tipo do ambiente
	 * @returns {boolean} True se for o ambiente especificado
	 */
	isEnvironment(environmentType) {
		return this.environmentInfo.type === environmentType;
	}

	/**
	 * Verifica se um recurso est√° dispon√≠vel
	 * @param {string} featureName - Nome do recurso
	 * @returns {boolean} True se o recurso estiver dispon√≠vel
	 */
	isFeatureAvailable(featureName) {
		return this.environmentInfo.availableFeatures[featureName] || false;
	}

	/**
	 * Obt√©m configura√ß√£o recomendada para uma chave espec√≠fica
	 * @param {string} configKey - Chave da configura√ß√£o
	 * @returns {*} Valor da configura√ß√£o
	 */
	getRecommendedConfigValue(configKey) {
		return this.environmentInfo.recommendedConfig[configKey];
	}
}

// Criar inst√¢ncia global
const environmentDetector = new EnvironmentDetector();

// Exportar para uso em m√≥dulos
export { environmentDetector, EnvironmentDetector };
export default environmentDetector;

// Disponibilizar globalmente
window.environmentDetector = environmentDetector;